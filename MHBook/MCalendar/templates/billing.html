<!DOCTYPE html>
<html lang="en">
<head>
    <title>Billing</title>
    <script>
        // Calculates the time difference between times in order to be able to calculate cost later
        function timeDiff(start, finish) { 
            const startTime = new Date(`1970-01-01T${start}:00`);
            const finishTime = new Date(`1970-01-01T${finish}:00`);
            let result = (finishTime - startTime) / (1000 * 60); 
            if (result < 0) {
                result += 24 * 60; 
            }
            return result;
        }

        // Simple cost function
        function calculateCost(rate, length) {
            const hour = length / 60;
            const result = hour * rate;
            return parseFloat(result.toFixed(2));
        }

        // Creates array to store costs
        let costsArray = [];

        // Simple function to add costs together
        function addCostToTotal(cost) {
            costsArray.push(cost);
        }

        // Function to then take those costs and display them. I probable over complicated this but whatevs
        function displayTotalCost() {
            const total = costsArray.reduce((sum, cost) => sum + cost, 0);
            document.getElementById("total-cost").textContent = "£" + total.toFixed(2);
        }

        // Necessary as bugs occured as function wasn't working. This basically waits until everything is loaded and then runs the function.
        document.addEventListener("DOMContentLoaded", displayTotalCost);

        function displaySupervisors() {
            // displays the checkboxes for supervisors
            let dropdown = document.getElementById('supervisorDropdown');
            let computedStyle = window.getComputedStyle(dropdown).display;
            if (computedStyle === 'none') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function displayBillingDropdown(ref) {
            // displays the billing information for selected billing
            let dropdown = document.getElementById(ref);
            let computedStyle = window.getComputedStyle(dropdown).display;
            if (computedStyle === 'none') {
                dropdown.style.display = 'grid';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function filter() {
            // changes global variables so that the billings displayed are filtered
        }

    </script>

    <style>

        #navBar {
            width: 80%;
            max-width: 800px;
            height: 50px;
            margin: 40px auto 80px auto;
            display: grid;
            grid-template-columns: 30% 25% 25% 20%;
        }

        .supervisorSearch {
            box-shadow: 2px 2px 5px hsl(265 0% 70%);
            border-radius: 5px;
            height: 40px;
            margin: auto;
            background-color: hsl(0 0 85%);
            border: none;
            padding: 10px;
            width: 90%;
            cursor: pointer;
        }

        #supervisorDropdown {
            border-radius: 5px;
            position: absolute;
            display: none;
            background-color: hsl(0 0 90%);
            box-shadow: 2px 2px 5px hsl(265 0% 70%);
            max-height: 100px;
            overflow-y: scroll;
        }

        #supervisorDropdown div {
            display: block;
            padding: 10px;
            cursor: pointer;
        }
        
        .dates {
            box-shadow: 2px 2px 5px hsl(265 0% 70%);
            border-radius: 5px;
            text-align: center;
            height: 40px;
            width: 90%;
            margin: auto;
            background-color: hsl(0 0 85%);
        }

        #filter {
            box-shadow: 2px 2px 5px hsl(265 0% 70%);
            border-radius: 5px;
            height: 40px;
            margin: auto;
            background-color: hsl(0 0 85%);
            border: none;
            padding: 10px;
            width: 80%;
            cursor: pointer;
        }

        .billingLabel {
            box-shadow: 2px 2px 5px hsl(265 0% 70%);
            border-radius: 5px;
            margin: 20px auto;
            background-color: hsl(0 0 85%);
            border: none;
            padding: 5px;
            width: 75%;
            max-width: 500px;
            cursor: pointer;
            display: grid;
            grid-template-columns: 25% 25% 25% 25%;
        }

        .billingDropdown {
            margin: auto;
            border-radius: 5px;
            display: grid;
            display: none;
            width: 70%;
            max-width: 450px;
            background-color: hsl(0 0 90%);
            box-shadow: 2px 2px 5px hsl(265 0% 70%);
            grid-template-columns: 50% 50%;
        }

    </style>
</head>

<body>

    <div id="navBar">
        <div>
        <button class="supervisorSearch" onclick="displaySupervisors()">-- Supervisors --</button>
            <div id="supervisorDropdown">
                <div>
                    <input type="checkbox" id="All" checked>
                    <label for="All">All</label>
                </div>
                {% for sup in supervisor %}
                    <div>
                        <input type="checkbox" id="{{ sup.id }}" value="{{ sup.id }}">
                        <label for="{{ sup.id }}">{{ sup.first_name }} {{ sup.last_name }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="dates">
            Start Date: 
            <div>{{ FiltersDateInput.my_date_field }}</div>
        </div>
        <div class="dates">
            End Date: 
            <div>{{ FiltersDateInput.my_date_field }}</div>
        </div>
        <button id="filter" onclick="filter"> Filter </button>
    </div>

    <!-- Konrad's Billing -->
    {% for x in billing %}
        <div class="billingLabel" onclick="displayBillingDropdown('{{x.invoiceRef}}')">
            <div>{{ x.invoiceRef }}</div>
            <div>
                <div>
                {% for y in x.supervisor.all %}
                    <div>{{ y.first_name }} {{ y.last_name }}</div>
                {% endfor %}
                </div>
            </div>
            <div>{{ x.startDate }}</div>
            <div>{{ x.finishDate }}</div>
        </div>
        <div class="billingDropdown" id="{{x.invoiceRef}}"> 
            <div>ID: {{ x.id }}</div>
            <div>Issued: {{ x.issueDate }}</div>
            <div>Users: <div>{% for user in x.user.all %}{{ user.first_name }} {{ user.last_name }}{% endfor %}</div></n></div>
        </div>
    {% endfor %}

    <!-- Oli's Billing -->
    {% for x in billing %}
        <div class="billingStuff">
            <h5 class="billingName">Billing ID: {{ x.id }}</h5>
        </div>

        <div class="detailsListItem">Invoice Reference no: {{ x.invoiceRef }}</div><br>
        <div class="detailsListItem">Invoice date of issue: {{ x.issueDate }}</div><br>
        <div class="detailsListItem">Start: {{ x.startDate }}</div>
        <div class="detailsListItem">Finish: {{ x.finishDate }}</div><br>

        <div class="detailsListItem">Supervisor:</div> {% comment %} Goes through all linked supervisors and displays thier names {% endcomment %}
        <ul>
            {% for y in x.supervisor.all %}
                <li>Supervisor first name: {{ y.first_name }}</li>
                <li>Supervisor last name: {{ y.last_name }}</li>
            {% endfor %}
        </ul>

        <div class="detailsListItem">User:</div>
        <ul>
            {% for y in x.user.all %} {% comment %} Same thing as supervisors but for users {% endcomment %}
                <li>User first name: {{ y.first_name }}</li>
                <li>User last name: {{ y.last_name }}</li>
            {% endfor %}
        </ul>

        <div class="detailsListItem">Booking: {{ x.bookingRef }}</div>
        {% comment %} Basically this next part filters through everything and makes sure only bookings that are within the time frame and have the required supervisors get displayed {% endcomment %}
        {% comment %} Also makes sure that only equipment with matching IDs gets displayed and charged {% endcomment %}
        <ul>
            {% for y in filterBooking %} {% comment %} Goes through all the filtered bookings. Filtering done in views, makes sure the bookings are within the date frame provided {% endcomment %}
                {% if y.date >= x.startDate and y.date <= x.finishDate %} {% comment %} Checks if within frame. {% endcomment %}
                    {% for supervisor in x.supervisor.all %} {% comment %} Goes through the linked supervisors {% endcomment %}
                        {% with supervisor_full_name=supervisor.first_name|add:" "|add:supervisor.last_name %} {% comment %} Annoying as booking model had one name filed but supervisor had two. So it bascially joins the two fields into one {% endcomment %}
                            {% if y.supervisor == supervisor_full_name %} {% comment %} Then compares the joint fields {% endcomment %}
                                {% for z in equipment %} {% comment %} Goes through all the equipment by accessing the equipment model {% endcomment %}
                                    {% if z.equipmentid == y.equipmentid %} {% comment %} If IDs match between the model and booking model {% endcomment %}
                                        <li>Booking Reference: {{ y.id }}</li>
                                        <ul>
                                            <li>Equipment ID: {{ z.equipmentid }}</li>
                                            <li>Equipment Name: {{ z.equipmentname }}</li>
                                            <li>Rate: {{ z.rate }}</li>
                                        </ul>
                                        <li>Length of equipment use: 
                                            <span id="length-{{ y.id }}"></span> {% comment %} Following lines call function to display length of equipment use {% endcomment %}
                                            <script>
                                                var startTime = "{{ y.start|time:'H:i' }}";
                                                var finishTime = "{{ y.finish|time:'H:i' }}";
                                                var length = timeDiff(startTime, finishTime);
                                                document.getElementById("length-{{ y.id }}").textContent = length + " minutes";
                                            </script>
                                        </li>
                                        <li>Cost of Equipment Use: 
                                            <span id="cost-{{ y.id }}"></span> {% comment %} Following lines call functions to calculate its cost and add to the total {% endcomment %}
                                            <script>
                                                var rate = parseFloat("{{ z.rate }}");
                                                var cost = calculateCost(rate, length);
                                                document.getElementById("cost-{{ y.id }}").textContent = "£" + cost;
                                                addCostToTotal(cost);
                                            </script>
                                        </li>
                                        <br>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </ul>
    {% endfor %}

    <div class="detailsListItem">Total Cost: <span id="total-cost">£0.00</span></div> {% comment %} Total cost!!! {% endcomment %}

</body>
</html>
