<!DOCTYPE html>
<html lang="en">
<head>
    <title>Billing</title>
    <script>
        function timeDiff(start, finish) {
            const startTime = new Date(`1970-01-01T${start}:00`);
            const finishTime = new Date(`1970-01-01T${finish}:00`);
            let result = (finishTime - startTime) / (1000 * 60); 
            if (result < 0) {
                result += 24 * 60; 
            }
            return result;
        }

        function calculateCost(rate, length) {
            const hour = length / 60;
            const result = hour * rate;
            return parseFloat(result.toFixed(2));
        }

        let costsArray = [];

        function addCostToTotal(cost) {
            costsArray.push(cost);
        }

        function displayTotalCost() {
            const total = costsArray.reduce((sum, cost) => sum + cost, 0);
            document.getElementById("total-cost").textContent = "£" + total.toFixed(2);
        }

        document.addEventListener("DOMContentLoaded", displayTotalCost);
    </script>
</head>

<body>

    {% for x in billing %}
        <div class="billingStuff">
            <h5 class="billingName">Billing ID: {{ x.id }}</h5>
        </div>

        <div class="detailsListItem">Invoice Reference no: {{ x.invoiceRef }}</div><br>
        <div class="detailsListItem">Invoice date of issue: {{ x.issueDate }}</div><br>
        <div class="detailsListItem">Start: {{ x.startDate }}</div>
        <div class="detailsListItem">Finish: {{ x.finishDate }}</div><br>

        <div class="detailsListItem">Supervisor:</div>
        <ul>
            {% for y in x.supervisor.all %}
                <li>Supervisor first name: {{ y.first_name }}</li>
                <li>Supervisor last name: {{ y.last_name }}</li>
            {% endfor %}
        </ul>

        <div class="detailsListItem">User:</div>
        <ul>
            {% for y in x.user.all %}
                <li>User first name: {{ y.first_name }}</li>
                <li>User last name: {{ y.last_name }}</li>
            {% endfor %}
        </ul>

        <div class="detailsListItem">Booking: {{ x.bookingRef }}</div>
        <ul>
            {% for y in filterBooking %}
                {% if y.date >= x.startDate and y.date <= x.finishDate %}
                    {% for z in equipment %}
                        {% if z.equipmentid == y.equipmentid %}
                            <li>Booking Reference: {{ y.id }}</li>
                            <ul>
                                <li>Equipment ID: {{ z.equipmentid }}</li>
                                <li>Equipment Name: {{ z.equipmentname }}</li>
                                <li>Rate: {{ z.rate }}</li>
                            </ul>
                            <li>Length of equipment use: 
                                <span id="length-{{ y.id }}"></span>
                                <script>
                                    var startTime = "{{ y.start|time:'H:i' }}";
                                    var finishTime = "{{ y.finish|time:'H:i' }}";
                                    var length = timeDiff(startTime, finishTime);
                                    document.getElementById("length-{{ y.id }}").textContent = length + " minutes";
                                </script>
                            </li>
                            <li>Cost of Equipment Use: 
                                <span id="cost-{{ y.id }}"></span>
                                <script>
                                    var rate = parseFloat("{{ z.rate }}");
                                    var cost = calculateCost(rate, length);
                                    document.getElementById("cost-{{ y.id }}").textContent = "£" + cost;
                                    addCostToTotal(cost);
                                </script>
                            </li>
                            <br>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        </ul>
    {% endfor %}

    <div class="detailsListItem">Total Cost: <span id="total-cost">£0.00</span></div>

</body>
</html>
