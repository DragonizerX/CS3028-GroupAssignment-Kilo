{% load static %}
{{ redirect_to_login_immediately }}
<!DOCTYPE html>
<html>

<head>

    <title>Calendar</title> <!--title for page-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.js'></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script> <!--links for necessary scripts and styling-->

    <link rel="stylesheet" href="{% static 'global.css' %}"> <!--link to external stylesheet-->

</head>

<body>

    <!-- This is the auto logout warning Message. DO NOT REMOVE! -->
    <div id="warningMessage" class="popWarning">Warning, the user is about to be logged out!</div>


    <!-- sidebar -->
    <div id="sidebar" class="sidenav">
        
        {% if user.is_superuser %} <!--direct to admin page for admins-->
            <a href="{% url 'CalendarPageAdmin' %}">Home</a>
        {% else %}
            <a href="{% url 'CalendarPage' %}">Home</a> <!--direct to regular page for non-admins-->
        {% endif %}

        <a href="{% url 'accountPage' %}">Account</a>
        <a href="{% url 'myBookings' %}">Bookings</a> <!--links to pages-->

        {% if user.is_superuser %}
            <a href="{% url 'requests' %}">Requests</a>
            <a href="{% url 'billings' %}">Billing</a>
            <a href="{% url 'archivePage' %}">Archive</a> <!--links to admin only pages-->
        {% endif %}

        <div class="sideCont">
            <a id="sidebarLogout" onclick="LogoutButton()">Logout</a> <!--logout button-->
        </div>
    </div>

    <!-- top bar (includes sidebar button and whatever else)-->
    <div class="container-fluid text-white topbar">
        <div class="row">
            <div class="col-2 container-fluid text-left">
            <span class="sidebarButton" style="position:relative; top: 11px;" onclick="toggleNav()">&#9776;</span> <!--button for sidebar-->
            </div>

            <div class="notification-box" onclick="togglePopup()"> <!--pop up for users who have cancelled short notice-->
                <strong>{{ short_notice_count }}</strong>
            </div>
            
            <div id="popup" class="popup" style="display: none;">
                <span class="close" onclick="togglePopup()">&times;</span>
                <div>
                    {% if short_notice_cancellations %} <!--loop through users who have cancelled on short notice-->
                        <p>List of all user who have cancelled on short notice today:</p>
                        <ul>
                            {% for cancellation in short_notice_cancellations %}
                                <li>Email: {{ cancellation.cancelled_by}}</li>
                            {% endfor %}
                        </ul>
                        <form action="{% url 'clear_cancelled_bookings' %}" method="post"> <!--option to clear pop up of information-->
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Clear All</button>
                        </form>
                    {% else %}
                        <p>No short-notice cancellations today.</p> <!--display if theres no SNC-->
                    {% endif %}
                </div>
            </div>
            
            <div class="col-8 container-fluid text-center h1">
                <h1 style="font-size: 40px; position: relative; bottom: 9px;">HistoTrack</h1> <!--website title text for top of page-->
            </div>
            <div class="col-2"></div>
        </div>
    </div>

    <div class="container rounded bg-white mt-5 mb-5 pb-5">
        <div class="container">
            <!--EQUIPMENT SELECTION-->
            <div id="equipmentSelect" class="form-group">
                        
                <label for="equipment">Select Equipment:</label> <!--select equipment button-->
                <select class="form-control" id="equipment" name="equipment" required>
                    <option value="">-- Select Equipment --</option>

                    {% for x in equipmentList %}
                        <option value="{{ x.equipmentID_auto}}">-- {{ x.equipmentName }} -- {{ x.hourlyRate }} --</option>
                    {% endfor %} <!--loop to recieve equipment list from backend-->

                </select>
            </div>

        <div class="text-center mt-4">

            {% if user.is_superuser %}
            <button class="btn btn-sty" type="button" data-toggle="collapse" data-target="#addEquipForm" aria-expanded="false" aria-controls="addEquipForm">
                Add Equipment 
            </button> <!--option for admin to add new equipment-->

            <button class="btn btn-sty" type="button" data-toggle="collapse" data-target="#deleteEquipForm" aria-expanded="false" aria-controls="deleteEquipForm">
                Delete Equipment 
            </button> <!--option for admin to delete equipment-->
            {% endif %}

                <div class="collapse mt-3" id="addEquipForm">
                    <div class="card card-body">
                        <form method="post" action="{% url 'add_equipment' %}">
                            {% csrf_token %}
                            <input type="hidden" id="addEquipmentInput" name="addEquipment" value=""> <!--input for adding equipment-->
                            <div class="row mt-2">
                                <div class="col-sm-3">
                                    <label for="equipmentName" class="control-label">Name of Equipment :</label> <!--new equipment name-->
                                </div>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="equipmentName" name="equipmentName" required>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-sm-3">
                                    <label for="hourlyRate" class="control-label">Hourly Rate for Equipment :</label> <!--new equipment rate-->
                                </div>
                                <div class="col-sm-9">
                                    <input type="float" class="form-control" id="hourlyRate" name="hourlyRate" required>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-sm-12 text-center">
                                    <button type="submit" class="btn btn-success">Confirm Addition of New Equipment</button> <!--button to confirm the addition-->
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            <div class="collapse mt-3" id="deleteEquipForm">
                <div class="card card-body">
                    <form method="post" action="{% url 'delete_equipment' %}" onSubmit="return confirm('Are you sure you want to delete the selected Equipment?\nThis action cannot be undone.')">
                        {% csrf_token %}
                        <input type="hidden" id="deleteEquipmentInput" name="deleteEquipment" value=""> <!--input for deleting equipment-->
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="delete_equipment" class="control-label">Select Equipment to Delete :</label> <!--option to select equipment to delete-->
                            </div>
                            <div class="col-sm-9">
                                <select class="form-control" id="delete_equipment" name="delete_equipment" required>
                                    <option value="">-- Select Equipment --</option>
                        
                                    {% for x in equipmentList %}
                                        <option value="{{ x.equipmentID_auto}}">-- {{ x.equipmentName }} -- {{ x.hourlyRate }} --</option>
                                    {% endfor %} <!--loop to recieve equipment list from backend to show for deletion-->
                        
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-sm-12 text-center">
                                <button type="submit" class="btn btn-danger">Confirm Deletion of Equipment</button> <!--button to confirm the deletion-->
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        </div>

        <!--CALENDAR-->
        <div id="calendar"></div> <!--Div for calendar (allows it to be rendered in correct position)-->
        
        <!--BOOKING FORM-->
        <div class="text-center mt-4">
            <button class="btn btn-sty" type="button" data-toggle="collapse" data-target="#bookingForm" aria-expanded="false" aria-controls="bookingForm">
                Make New Booking <!--make new booking button-->
            </button>
            
            <div class="collapse mt-3" id="bookingForm">
                <div class="card card-body">
                    <form method="post" action="{% url 'create_event' %}"> <!--get create event from views.py file-->
                        {% csrf_token %}
                        <input type="hidden" id="equipmentInput" name="equipment" value="">
                        
                        {% if user.is_superuser %} <!--admin only feature-->
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="user_email" class="control-label">User Email:</label> <!--option to input any email for booking-->
                            </div>
                            <div class="col-sm-9">
                                <input type="email" class="form-control" id="user_email" name="user_email">
                            </div>
                        </div>
                        {% endif %}

                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="supervisorName" class="control-label">Supervisor:</label> <!--option for supervisor-->
                            </div>
                            <div class="col-sm-7">
                                <!-- Search Input Field -->
                                <input type="text" autocomplete="off" id="supervisorSearch" class="form-control" placeholder="Search for a supervisor" onkeyup="filterSupervisors()">
                                
                                <!-- Custom Dropdown -->
                                <div id="supervisorDropdown" class="dropdown-content">
                                    {% for supervisor in supervisors %} <!--loop through supervisor list-->
                                        <div class="dropdown-item" onclick="selectSupervisor('{{ supervisor.id }}', '{{ supervisor.first_name }} {{ supervisor.last_name }}')">
                                            {{ supervisor.first_name }} {{ supervisor.last_name }} <!--get name of supervisor-->
                                        </div>
                                    {% empty %}
                                        <div class="dropdown-item">No supervisors available</div> <!--display when no supervisors in list-->
                                    {% endfor %}
                                </div>
                        
                                <!-- Hidden Input to Store Selected Supervisor ID -->
                                <input type="hidden" name="supervisorName" id="selectedSupervisorId" required>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" class="btn btn-sty btn-block" data-toggle="modal" data-target="#addSupervisorModal">
                                    Add New <!--option to add new supervisor-->
                                </button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="bookingDate" class="control-label">Date of Booking:</label> <!--option for booking date-->
                            </div>
                            <div class="col-sm-9">
                                <input type="date" class="form-control" id="bookingDate" name="bookingDate" required> <!--date input type-->
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="startTime" class="control-label">Start Time:</label> <!--option for start time-->
                            </div>
                            <div class="col-sm-9">
                                <select class="form-control" id="startTime" name="startTime" required> <!--dropdown for start time with apppropriate options-->
                                    <option value="00:00">00:00</option>
                                    <option value="00:15">00:15</option>
                                    <option value="00:30">00:30</option>
                                    <option value="00:45">00:45</option>
                                    <option value="01:00">01:00</option>
                                    <option value="01:15">01:15</option>
                                    <option value="01:30">01:30</option>
                                    <option value="01:45">01:45</option>
                                    <option value="02:00">02:00</option>
                                    <option value="02:15">02:15</option>
                                    <option value="02:30">02:30</option>
                                    <option value="02:45">02:45</option>
                                    <option value="03:00">03:00</option>
                                    <option value="03:15">03:15</option>
                                    <option value="03:30">03:30</option>
                                    <option value="03:45">03:45</option>
                                    <option value="04:00">04:00</option>
                                    <option value="04:15">04:15</option>
                                    <option value="04:30">04:30</option>
                                    <option value="04:45">04:45</option>
                                    <option value="05:00">05:00</option>
                                    <option value="05:15">05:15</option>
                                    <option value="05:30">05:30</option>
                                    <option value="05:45">05:45</option>
                                    <option value="06:00">06:00</option>
                                    <option value="06:15">06:15</option>
                                    <option value="06:30">06:30</option>
                                    <option value="06:45">06:45</option>
                                    <option value="07:00">07:00</option>
                                    <option value="07:15">07:15</option>
                                    <option value="07:30">07:30</option>
                                    <option value="07:45">07:45</option>
                                    <option value="08:00">08:00</option>
                                    <option value="08:15">08:15</option>
                                    <option value="08:30">08:30</option>
                                    <option value="08:45">08:45</option>
                                    <option value="09:00">09:00</option>
                                    <option value="09:15">09:15</option>
                                    <option value="09:30">09:30</option>
                                    <option value="09:45">09:45</option>
                                    <option value="10:00">10:00</option>
                                    <option value="10:15">10:15</option>
                                    <option value="10:30">10:30</option>
                                    <option value="10:45">10:45</option>
                                    <option value="11:00">11:00</option>
                                    <option value="11:15">11:15</option>
                                    <option value="11:30">11:30</option>
                                    <option value="11:45">11:45</option>
                                    <option value="12:00">12:00</option>
                                    <option value="12:15">12:15</option>
                                    <option value="12:30">12:30</option>
                                    <option value="12:45">12:45</option>
                                    <option value="13:00">13:00</option>
                                    <option value="13:15">13:15</option>
                                    <option value="13:30">13:30</option>
                                    <option value="13:45">13:45</option>
                                    <option value="14:00">14:00</option>
                                    <option value="14:15">14:15</option>
                                    <option value="14:30">14:30</option>
                                    <option value="14:45">14:45</option>
                                    <option value="15:00">15:00</option>
                                    <option value="15:15">15:15</option>
                                    <option value="15:30">15:30</option>
                                    <option value="15:45">15:45</option>
                                    <option value="16:00">16:00</option>
                                    <option value="16:15">16:15</option>
                                    <option value="16:30">16:30</option>
                                    <option value="16:45">16:45</option>
                                    <option value="17:00">17:00</option>
                                    <option value="17:15">17:15</option>
                                    <option value="17:30">17:30</option>
                                    <option value="17:45">17:45</option>
                                    <option value="18:00">18:00</option>
                                    <option value="18:15">18:15</option>
                                    <option value="18:30">18:30</option>
                                    <option value="18:45">18:45</option>
                                    <option value="19:00">19:00</option>
                                    <option value="19:15">19:15</option>
                                    <option value="19:30">19:30</option>
                                    <option value="19:45">19:45</option>
                                    <option value="20:00">20:00</option>
                                    <option value="20:15">20:15</option>
                                    <option value="20:30">20:30</option>
                                    <option value="20:45">20:45</option>
                                    <option value="21:00">21:00</option>
                                    <option value="21:15">21:15</option>
                                    <option value="21:30">21:30</option>
                                    <option value="21:45">21:45</option>
                                    <option value="22:00">22:00</option>
                                    <option value="22:15">22:15</option>
                                    <option value="22:30">22:30</option>
                                    <option value="22:45">22:45</option>
                                    <option value="23:00">23:00</option>
                                    <option value="23:15">23:15</option>
                                    <option value="23:30">23:30</option>
                                    <option value="23:45">23:45</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="finishTime" class="control-label">End Time:</label> <!--option for end time-->
                            </div>
                            <div class="col-sm-9">
                                <select class="form-control" id="finishTime" name="finishTime" required> <!--dropdown for end time with appropriate values-->
                                    <option value="00:00">00:00</option>
                                    <option value="00:15">00:15</option>
                                    <option value="00:30">00:30</option>
                                    <option value="00:45">00:45</option>
                                    <option value="01:00">01:00</option>
                                    <option value="01:15">01:15</option>
                                    <option value="01:30">01:30</option>
                                    <option value="01:45">01:45</option>
                                    <option value="02:00">02:00</option>
                                    <option value="02:15">02:15</option>
                                    <option value="02:30">02:30</option>
                                    <option value="02:45">02:45</option>
                                    <option value="03:00">03:00</option>
                                    <option value="03:15">03:15</option>
                                    <option value="03:30">03:30</option>
                                    <option value="03:45">03:45</option>
                                    <option value="04:00">04:00</option>
                                    <option value="04:15">04:15</option>
                                    <option value="04:30">04:30</option>
                                    <option value="04:45">04:45</option>
                                    <option value="05:00">05:00</option>
                                    <option value="05:15">05:15</option>
                                    <option value="05:30">05:30</option>
                                    <option value="05:45">05:45</option>
                                    <option value="06:00">06:00</option>
                                    <option value="06:15">06:15</option>
                                    <option value="06:30">06:30</option>
                                    <option value="06:45">06:45</option>
                                    <option value="07:00">07:00</option>
                                    <option value="07:15">07:15</option>
                                    <option value="07:30">07:30</option>
                                    <option value="07:45">07:45</option>
                                    <option value="08:00">08:00</option>
                                    <option value="08:15">08:15</option>
                                    <option value="08:30">08:30</option>
                                    <option value="08:45">08:45</option>
                                    <option value="09:00">09:00</option>
                                    <option value="09:15">09:15</option>
                                    <option value="09:30">09:30</option>
                                    <option value="09:45">09:45</option>
                                    <option value="10:00">10:00</option>
                                    <option value="10:15">10:15</option>
                                    <option value="10:30">10:30</option>
                                    <option value="10:45">10:45</option>
                                    <option value="11:00">11:00</option>
                                    <option value="11:15">11:15</option>
                                    <option value="11:30">11:30</option>
                                    <option value="11:45">11:45</option>
                                    <option value="12:00">12:00</option>
                                    <option value="12:15">12:15</option>
                                    <option value="12:30">12:30</option>
                                    <option value="12:45">12:45</option>
                                    <option value="13:00">13:00</option>
                                    <option value="13:15">13:15</option>
                                    <option value="13:30">13:30</option>
                                    <option value="13:45">13:45</option>
                                    <option value="14:00">14:00</option>
                                    <option value="14:15">14:15</option>
                                    <option value="14:30">14:30</option>
                                    <option value="14:45">14:45</option>
                                    <option value="15:00">15:00</option>
                                    <option value="15:15">15:15</option>
                                    <option value="15:30">15:30</option>
                                    <option value="15:45">15:45</option>
                                    <option value="16:00">16:00</option>
                                    <option value="16:15">16:15</option>
                                    <option value="16:30">16:30</option>
                                    <option value="16:45">16:45</option>
                                    <option value="17:00">17:00</option>
                                    <option value="17:15">17:15</option>
                                    <option value="17:30">17:30</option>
                                    <option value="17:45">17:45</option>
                                    <option value="18:00">18:00</option>
                                    <option value="18:15">18:15</option>
                                    <option value="18:30">18:30</option>
                                    <option value="18:45">18:45</option>
                                    <option value="19:00">19:00</option>
                                    <option value="19:15">19:15</option>
                                    <option value="19:30">19:30</option>
                                    <option value="19:45">19:45</option>
                                    <option value="20:00">20:00</option>
                                    <option value="20:15">20:15</option>
                                    <option value="20:30">20:30</option>
                                    <option value="20:45">20:45</option>
                                    <option value="21:00">21:00</option>
                                    <option value="21:15">21:15</option>
                                    <option value="21:30">21:30</option>
                                    <option value="21:45">21:45</option>
                                    <option value="22:00">22:00</option>
                                    <option value="22:15">22:15</option>
                                    <option value="22:30">22:30</option>
                                    <option value="22:45">22:45</option>
                                    <option value="23:00">23:00</option>
                                    <option value="23:15">23:15</option>
                                    <option value="23:30">23:30</option>
                                    <option value="23:45">23:45</option>
                                </select>
                            </div>
                        </div>
                        {% if user.is_superuser %} <!--admin only feature-->
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="customPrice" class="control-label">Booking Price (per hour) :</label> <!--allow for input of cutom price-->
                            </div>
                            <div class="col-sm-9">
                                <input type="number" step="0.01" class="form-control" id="customPrice" name="customPrice">
                            </div>
                        </div>
                        {% endif %}
                        <div class="row mt-2">
                            <div class="col-sm-3">
                                <label for="notes" class="control-label">Notes:</label> <!--option for extra comments-->
                            </div>
                            <div class="col-sm-9">
                                <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Enter Project Information: E.g: (Project Name/Project Info)"></textarea>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-sm-12 text-center">
                                <button type="submit" class="btn btn-success">Confirm Booking</button> <!--button to confirm the booking-->
                            </div>
                        </div>
                    </form>
                    <div class="modal fade" id="addSupervisorModal" tabindex="-1" role="dialog" aria-labelledby="addSupervisorModalLabel" aria-hidden="true"> 
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addSupervisorModalLabel">Add New Supervisor</h5> <!-- Modal for adding new supervisor to table -->
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="addSupervisorForm">
                                        <div class="form-group">
                                            <label for="firstName">First Name:</label> <!-- Input for new supervisor field -->
                                            <input type="text" class="form-control" id="firstName" name="first_name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="lastName">Last Name:</label> <!-- Input for new supervisor last name field -->
                                            <input type="text" class="form-control" id="lastName" name="last_name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="email">Email:</label> <!-- Input for new supervisor email field -->
                                            <input type="email" class="form-control" id="email" name="email" required>
                                        </div>
                                    </form>
                                </div>
                                <div class="container px-5">
                                    <div class="text-center">
                                    <button type="button" class="detailsListItem btn btn-block btn-success" id="submitSupervisor">Add Supervisor</button> <!--button to confirm new addition of supervisor-->
                                    <button type="button" class="detailsListItem btn btn-block btn-danger " data-dismiss="modal">Close</button>
                                    </div>
                                </div>
                                <br>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--JAVASCRIPT SCRIPTS-->
    <script>
        document.addEventListener('DOMContentLoaded', function() { //creation of calendar options
            var calendarEl = document.getElementById('calendar'); //get calendar ID defined earlier
            var calendar = new FullCalendar.Calendar(calendarEl, { //implement javascript fullcalendar
                initialView: 'timeGridWeek', //display calendar in specific time and week format
                allDaySlot: false,
                slotMinTime: '00:00:00', //time displays in calendar
                slotMaxTime: '24:00:00',
                slotDuration: '00:15:00',
                snapDuration: '00:15:00',
                headerToolbar: { //options and display for selecting and viewing particular week
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },
                slotLabelInterval: 15,
                slotLabelFormat: { //options for calendar time displays
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                selectable: true, //make specific times selectable

                select: function(info) {
                    var date = info.start.toISOString().split('T')[0];
                    var startTime = info.start.getHours().toString().padStart(2, '0') + ':' + (Math.floor(info.start.getMinutes() / 15) * 15).toString().padStart(2, '0');
                    var endTime = info.end.getHours().toString().padStart(2, '0') + ':' + (Math.floor(info.end.getMinutes() / 15) * 15).toString().padStart(2, '0'); //autofill date and times
                    
                    document.getElementById('bookingDate').value = date;
                    document.getElementById('startTime').value = startTime;
                    
                    // Validate and set end time
                    const startHour = parseInt(startTime.split(':')[0]);
                    const endHour = parseInt(endTime.split(':')[0]); //parse times and assign to new variables
                    
                    if(endHour <= startHour) {
                        endTime = `${String(startHour + 1).padStart(2, '0')}:00`; //set default endtime to 1 hour after start
                    }
                    
                    document.getElementById('finishTime').value = endTime;
                    updateEndTimeOptions(); // Update available end times
                    $('#bookingForm').collapse('show');
                },

                height: 'auto',
                expandRows: true,
                events: function(fetchInfo, successCallback, failureCallback) {
                    const equipment = document.getElementById('equipment').value; //get selected equipment
                    
                    if (!equipment) {
                        successCallback([]); // Return empty array if no equipment selected
                        return;
                    }
                    
                    fetch(`/MCalendar/CalendarPage/get_events/?equipment=${encodeURIComponent(equipment)}`) //recieve get events from views.py file
                        .then(response => response.json())
                        .then(data => {
                            const eventsWithDetails = data.map(event => ({
                                ...event,
                                title: `${event.title}\nSupervisor: ${event.supervisorName}\nNotess: ${event.notes || 'None'}`
                            }));
                            successCallback(eventsWithDetails);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            failureCallback(error); //give error if get events cant be retrieved
                        });
                },
                eventContent: function(arg) {
                    return {
                        html: `<div class = "fc-event-content">
                            <b>${arg.event.title.split('\n')[0]}</b><br>
                            <small>${arg.event.title.split('\n')[1]}</small><br>
                            <small>${arg.event.title.split('\n')[2]}</small>
                        </div>`
                    }; //display relevant information on calendar from get events
                },
                eventDidMount: function(info) {
                    $(info.el).tooltip({
                        title: info.event.title,
                        placement: 'top',
                        html: true,
                        template: '<div class="tooltip admin-information" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>'
                    }); //tooltip to display extra information when bookings are hovered over
                },

                eventClassNames: 'bookedSlot'
            });
            
            calendar.render(); //render the calendar
        
            // Time validation functions
            function updateEndTimeOptions() {
                const startTime = document.getElementById('startTime').value;
                const finishTimeSelect = document.getElementById('finishTime');
                const [startHour, startMinute] = startTime.split(':').map(Number);                
                const startInMinutes = startHour * 60 + startMinute;
                finishTimeSelect.innerHTML = '';
               
                for (let time = startInMinutes + 15; time < 24 * 60; time += 15) {
                    const hour = Math.floor(time / 60).toString().padStart(2, '0');
                    const minutes = (time % 60).toString().padStart(2, '0');
                    const timeStr = `${hour}:${minutes}`;                  
                    const option = new Option(timeStr, timeStr);
                    finishTimeSelect.appendChild(option);
                }
                           
                if (finishTimeSelect.value === '') {
                    const defaultHour = Math.floor((startInMinutes + 60) / 60).toString().padStart(2, '0');
                    const defaultMinutes = ((startInMinutes + 60) % 60).toString().padStart(2, '0');
                    finishTimeSelect.value = `${defaultHour}:${defaultMinutes}`;
                }
                
            }
        
            function validateTimes() {
                const startTime = document.getElementById('startTime').value;
                const finishTime = document.getElementById('finishTime').value;
                const startHour = parseInt(startTime.split(':')[0]);
                const finishHour = parseInt(finishTime.split(':')[0]);
                const startMin = parseInt(startTime.split(':')[1]);
                const finishMin = parseInt(finishTime.split(':')[1]);
                console.log(finishHour,startHour,finishMin,startMin);
                
                if(finishHour <= startHour && finishMin <= startMin) {
                    alert('End time must be after start time');
                    document.getElementById('finishTime').value = 
                        `${String(startHour + 0.25).padStart(2, '0')}:00`;
                }
            } //validation to make sure of valid end time in case of manual entry
        
            // Add event listeners for time validation
            document.getElementById('startTime').addEventListener('change', updateEndTimeOptions);
            document.getElementById('finishTime').addEventListener('change', validateTimes);
        
            // Equipment change handler
            document.getElementById('equipment').addEventListener('change', function() {
                const selectedEquipment = this.value;
                document.getElementById('equipmentInput').value = selectedEquipment; //ensure equipment selection is tracked
                calendar.refetchEvents();
            });
        
            // Form submission handler
            document.querySelector('#bookingForm form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const startTime = document.getElementById('startTime').value;
                const finishTime = document.getElementById('finishTime').value;
                const startHour = parseInt(startTime.split(':')[0]);
                const finishHour = parseInt(finishTime.split(':')[0]);
                const startMin = parseInt(startTime.split(':')[1]);
                const finishMin = parseInt(finishTime.split(':')[1]); //ensure times are parsed
                
                if(finishHour <= startHour && finishMin <= startMin) {
                    alert('End time must be after start time');
                    return; //alert for end time being before start time
                }
        
                var formData = new FormData(this);
                var selectedEquipment = document.getElementById('equipment').value;
                formData.append('equipment', selectedEquipment);
                
                if (!selectedEquipment) {
                    alert('Please select equipment before submitting the booking.'); //ensure equipment is handled
                    return;
                }

                const selectedOption = document.getElementById('equipment').options[document.getElementById('equipment').selectedIndex];
                const hourlyRate = selectedOption.text.split('--')[2].trim(); 
                formData.append('hourlyRate', hourlyRate); //ensure hourlyRate is handled

                const userEmailField = document.getElementById('user_email');
                if (userEmailField) {
                    formData.append('user_email', userEmailField.value); //ensure custom email field is handled
                }
        
                fetch("{% url 'create_event' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        calendar.refetchEvents(); // Refresh calendar to show new booking
                        $('#bookingForm').collapse('hide'); //collapse booking form if necessary
                        this.reset();
                        document.getElementById('equipment').value = selectedEquipment;
                        document.getElementById('equipmentInput').value = selectedEquipment; //get equipment
                    } else if (data.status === 'error') {
                        alert(data.message); //error handling
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
        
        function toggleNav() {
            var element = document.getElementById("sidebar");
            element.classList.toggle("toggle"); //toggle the navigation bar
        }
        
        function LogoutButton() {
            if (confirm("You are about to logout,\nAre you sure you want to continue?")) {
                window.location.href="{% url 'logout' %}";
            } else {
                none;
            } //implement logout option
        }

            document.getElementById('submitSupervisor').addEventListener('click', function() {
        var form = document.getElementById('addSupervisorForm');
        var firstName = document.getElementById('firstName');
        var lastName = document.getElementById('lastName');
        var email = document.getElementById('email');
        var telephone = document.getElementById('telephone'); //get necessary details for booking

        // Validate each field and store error messages
        var errors = [];

        if (!firstName.value.trim()) errors.push("First Name is required.");
        if (!lastName.value.trim()) errors.push("Last Name is required.");
        if (!email.value.trim()) errors.push("Email is required."); //handling for missing information

        // If there are errors, display them and prevent form submission
        if (errors.length > 0) {
            alert(errors.join("\n"));
            return; // Stop submission if there are errors
        }

        // If no errors, proceed with form submission
        var formData = new FormData(form);
        fetch("{% url 'add_supervisor' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                $('#addSupervisorModal').modal('hide'); //hide modal unless selected
                form.reset();
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    });
            
            document.getElementById("supervisorSearch").addEventListener("focus", function() {
            document.getElementById("supervisorDropdown").style.display = "block";
    });

    function filterSupervisors() {
        const searchInput = document.getElementById("supervisorSearch").value.toLowerCase();
        const dropdown = document.getElementById("supervisorDropdown");
        const items = dropdown.getElementsByClassName("dropdown-item"); //get supervisor options

        for (let i = 0; i < items.length; i++) {
            const itemText = items[i].innerText.toLowerCase();
            items[i].style.display = itemText.includes(searchInput) ? "" : "none"; //display for supervisors
        }
    }

    function selectSupervisor(id, name) {
        document.getElementById("supervisorSearch").value = name; // Show selected supervisor in search field
        document.getElementById("selectedSupervisorId").value = id; // Set selected supervisor ID
        document.getElementById("supervisorDropdown").style.display = "none"; // Hide the dropdown
    }

    // Close dropdown if clicked outside
    document.addEventListener("click", function(event) {
        const dropdown = document.getElementById("supervisorDropdown");
        if (!dropdown.contains(event.target) && event.target.id !== "supervisorSearch") {
            dropdown.style.display = "none";
        }
    });

    
    function togglePopup() {
    var popup = document.getElementById('popup'); //options for SNC popup
    if (popup.style.display === "none" || popup.style.display === "") {
        popup.style.display = "block"; // Show the popup
    } else {
        popup.style.display = "none"; // Hide the popup
    }
    }

    // This is the auto-logout code, do not change!
    let idleTime = 0; //creation of a timer initially 0
    const idleTimeout = 300; //idle timeout time
    const warningTimeout = 290; //timer for when warning for timeout is displayed
    let messageBox = document.getElementById("warningMessage");

    function resetTime() {
        idleTime = 0;
        messageBox.style.display = ("none");
    }

    function cycle() {
        idleTime++; //increment time
        if (idleTime >= warningTimeout) {
            warningMessage();
        }
        if (idleTime >= idleTimeout) {
            logoutUser();
        } //ensuring warning is displayed and logout works
    }

    function warningMessage() {
        messageBox.style.display = ("block");
    } //styling for warning

    function logoutUser() {
        window.location.href = "{% url 'logout' %}";
    } //logging user out

    window.onload = function() {
        document.onmousemove = resetTime;
        document.onkeypress = resetTime;
        setInterval(cycle, 1000);
    }; //ensuring that if user is active to reset timer
    // End of auto-logout code

    </script>
</body>
</html>